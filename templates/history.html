<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Feedback History - AI Resume Ranker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f6f7fb; }
    .card { border: 0; border-radius: 1rem; box-shadow: 0 10px 28px rgba(0,0,0,.08); }
    .page-title { font-weight: 700; letter-spacing: .2px; }
    .table thead th { position: sticky; top: 0; z-index: 1; background: #0d6efd; color: #fff; }
    .metric { display: inline-flex; align-items: center; gap:.5rem; padding:.4rem .75rem; border-radius: 999px; background:#f1f3f5; }
    .metric .dot { width:8px; height:8px; border-radius:50%; display:inline-block; }
    .metric.total .dot { background:#6c757d; }
    .metric.sel   .dot { background:#198754; }
    .metric.rej   .dot { background:#dc3545; }
    .search-input { max-width: 360px; }
    .badge-pill { border-radius: 999px; padding: .45rem .7rem; font-weight: 500; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="{{ url_for('index') }}">AI Resume Ranker</a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="{{ url_for('index') }}">Home</a></li>
        <li class="nav-item"><a class="nav-link active" href="{{ url_for('history') }}">Feedback History</a></li>
      </ul>
      <a href="{{ url_for('index') }}" class="btn btn-outline-light btn-sm">＋ New Run</a>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div class="card p-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
      <h3 class="page-title m-0">Recruiter Feedback History</h3>

      <div class="d-flex align-items-center gap-3">
        <span class="metric total"><span class="dot"></span> Total: <strong id="countTotal">0</strong></span>
        <span class="metric sel"><span class="dot"></span> Selected: <strong id="countSelected">0</strong></span>
        <span class="metric rej"><span class="dot"></span> Rejected: <strong id="countRejected">0</strong></span>
        <input id="searchBox" class="form-control form-control-sm search-input" type="search" placeholder="Search filename or decision…">
      </div>
    </div>

    {% if tables %}
      {% for table in tables %}
        <div class="table-responsive" style="max-height: 70vh;">
          <!-- We add classes here so pandas table inherits Bootstrap styling -->
          <div class="border rounded overflow-hidden">
            {{ table|safe }}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="alert alert-secondary mb-0">No feedback yet.</div>
    {% endif %}

    <div class="d-flex justify-content-end mt-3">
      <a href="{{ url_for('index') }}" class="btn btn-secondary">⬅ Back to Upload</a>
    </div>
  </div>
</div>

<script>
  // Enhance the pandas-rendered table: add Bootstrap classes, counts, badges, and search.
  (function () {
    const table = document.querySelector('.card table');
    if (!table) {
      // no table yet (e.g., "No feedback yet.")
      return;
    }

    // Ensure bootstrap classes are present even if pandas didn't include them everywhere
    table.classList.add('table', 'table-striped', 'table-hover', 'align-middle', 'mb-0');

    // Find column indexes by header text
    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim().toLowerCase());
    const filenameCol = headers.indexOf('filename');
    const decisionCol = headers.indexOf('decision');

    let total = 0, selected = 0, rejected = 0;

    // Convert decision text to badges + compute counts
    table.querySelectorAll('tbody tr').forEach(tr => {
      const cells = tr.querySelectorAll('td');
      if (!cells.length) return;
      total += 1;

      if (decisionCol >= 0) {
        const td = cells[decisionCol];
        const val = (td.textContent || '').trim().toLowerCase();
        let badgeClass = 'bg-secondary', label = val || '—';
        if (val === 'selected') { badgeClass = 'bg-success'; selected += 1; }
        if (val === 'rejected') { badgeClass = 'bg-danger';  rejected += 1; }
        td.innerHTML = `<span class="badge ${badgeClass} badge-pill text-capitalize">${label}</span>`;
      }
    });

    // Update counters
    document.getElementById('countTotal').textContent = total;
    document.getElementById('countSelected').textContent = selected;
    document.getElementById('countRejected').textContent = rejected;

    // Client-side search on filename and decision
    const searchBox = document.getElementById('searchBox');
    searchBox?.addEventListener('input', function () {
      const q = this.value.trim().toLowerCase();
      table.querySelectorAll('tbody tr').forEach(tr => {
        const fn = filenameCol >= 0 ? (tr.children[filenameCol]?.textContent || '') : tr.textContent;
        const dc = decisionCol >= 0 ? (tr.children[decisionCol]?.textContent || '') : '';
        const show = fn.toLowerCase().includes(q) || dc.toLowerCase().includes(q);
        tr.style.display = show ? '' : 'none';
      });
    });
  })();
</script>

</body>
</html>
